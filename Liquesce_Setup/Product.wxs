<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension"
     xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
     >

   <?define MgtSource=$(sys.SOURCEFILEDIR)..\LiquesceFTPMgr\bin\Release ?>
   <?define SvcSource=$(sys.SOURCEFILEDIR)..\LiquesceFTPSvc\bin\Release ?>
   <?define TraySource=$(sys.SOURCEFILEDIR)..\LiquesceFTPTray\bin\Release ?>


   <!-- do not change this ever !-->
   <?define UpgradeCode = "F6F94F17-A05F-4824-8DD9-9F5E8267D784" ?>

   <!-- Change this when creating new release YY-MM-DD -->
   <?define Version = "11.03.23" ?>
   
   <?define ProductName = "Liquesce FTP Windows HDD Pooling Suite"?>

   <Product Version="$(var.Version)" Id="*" UpgradeCode="$(var.UpgradeCode)"
          Name="$(var.ProductName)" Language="1033" Manufacturer="http://liquesce.codeplex.com/" >

      <Package Id="*" Keywords='Installer'
               InstallScope='perMachine'
               Description="$(var.ProductName)"
               Comments="Liquesce FTP" InstallerVersion="301" Compressed="yes"
               AdminImage='no'
               Platform='x86'
               />

      <MajorUpgrade DowngradeErrorMessage="Downgrades are not allowed - Use add/remove from the control panel" />

      <!-- Support Information shown in Add/Remove programs (this is optional) -->
      <Property Id="ARPHELPLINK" Value="http://liquesce.codeplex.com/documentation" />
      <Property Id="ARPCOMMENTS" Value="http://liquesce.codeplex.com/discussions"/>
      <Property Id="ARPCONTACT" Value="Smurf-IV" />
      <Property Id="ARPURLINFOABOUT" Value="http://liquesce.codeplex.com/" />
      <Icon Id="InstallerIcon" SourceFile="$(sys.SOURCEFILEDIR)..\LiquesceFTPMgr\Resources\Liquesce.ico" />
      <Property Id="ARPPRODUCTICON" Value="InstallerIcon" />

      <!-- Properties to allow detection of .Net installation -->
      <PropertyRef Id="NETFRAMEWORK40FULL"/>
      <PropertyRef Id="NETFRAMEWORK40FULLINSTALLROOTDIR" />


      <!--Some test conditions to allow the installer to run-->
      <Condition Message="[ProductName] Requires .NET Framework 4.0 Main profile to be installed">
         <![CDATA[Installed OR NETFRAMEWORK40FULL]]>
      </Condition>
      <Condition Message="You need to be an administrator to install this product.">
         Privileged
      </Condition>


      <!--Allow 7z / zip compression to squeeze this tighter -->
      <Media Id="1" Cabinet="Setup.cab" EmbedCab="yes" CompressionLevel="high" />

      <Directory Id="TARGETDIR" Name="SourceDir">
         <Directory Id="ProgramFilesFolder">
            <Directory Id="INSTALLDIR" Name="LiquesceFTP">
               <Directory Id="ClientDIR" Name="Liquesce FTP Client">
               </Directory>
               <Directory Id="ServiceDIR" Name="Liquesce FTP Service">
               </Directory>
            </Directory>
         </Directory>
         <Directory Id="ProgramMenuFolder">
            <Directory Id="ProgramMenuDir" Name="Liquesce FTP"/>
            <Directory Id="StartupFolder" Name="Startup" />
         </Directory>

         <Directory Id="CommonAppDataFolder" Name="CommonAppData">
            <Directory Id="LiquesceFTPSvc_Data" Name="LiquesceFTPSvc" >
               <Component Id="DataDir" Guid="01234567-7E98-44CE-B049-C477CC0A2B01" KeyPath="yes" />
            </Directory>
         </Directory>

      </Directory>

      <ComponentGroup Id="Client" >
         <Component Id="Client" Guid="5EBF3F29-9CF1-44FE-A94C-CC1B4FE09367" Directory="ClientDIR">
            <File Id="InstallerIcon" Name="Liquesce.ico" Source="$(sys.SOURCEFILEDIR)..\LiquesceFTPMgr\Resources\Liquesce.ico" />
            <File Id="LiquesceFTPMgr.exe" Name="LiquesceFTPMgr.exe" Source="$(var.MgtSource)\LiquesceFTPMgr.exe" KeyPath="yes">
               <fire:FirewallException Id="LiquesceFWX1" Name="Liquesce Mount Management" Scope="localSubnet" IgnoreFailure="yes" />
            </File>
         </Component>
         <Component Id="ChangeLog" Directory="ClientDIR">
            <File Source="$(sys.SOURCEFILEDIR)..\LiquesceFTPMgr\ChangeLog.rtf" KeyPath="yes" />
         </Component>
         <Component Id="LiquesceFTPMgr.exe.config" Directory="ClientDIR">
            <File Source="$(var.MgtSource)\LiquesceFTPMgr.exe.config" KeyPath="yes" />
         </Component>
         <Component Id="C_NLog.dll" Directory="ClientDIR">
            <File Id="C_NLog.dll" Source="$(var.MgtSource)\NLog.dll" KeyPath="yes" />
         </Component>
         <Component Id="C_LiquesceFTPFacade.dll" Directory="ClientDIR">
            <File Id="C_LiquesceFTPFacade.dll" Source="$(var.MgtSource)\LiquesceFTPFacade.dll" KeyPath="yes" />
         </Component>
         <Component Id="LiquesceFTPTray.exe.config" Directory="ClientDIR">
            <File Source="$(var.TraySource)\LiquesceFTPTray.exe.config" KeyPath="yes" />
         </Component>
         <Component Id="LiquesceFTPTray.exe" Directory="ClientDIR">
            <File Source="$(var.TraySource)\LiquesceFTPTray.exe" KeyPath="yes" />
         </Component>
      </ComponentGroup>
      <ComponentGroup Id="Service">
         <Component Id="LiquesceFTPSvc" Guid="BEBF3F29-9CF1-44FE-A94C-CC1B4FE09367" Directory="ServiceDIR">
            <File Id="LiquesceFTPSvc.File" Name="LiquesceFTPSvc.exe" Source="$(var.SvcSource)\LiquesceFTPSvc.exe" KeyPath="yes">
               <fire:FirewallException Id="LiquesceFWX2" Name="LiquesceFTPSvc" Scope="localSubnet" IgnoreFailure="yes" />
               <!-- Why Use NGen ? http://msdn.microsoft.com/en-gb/magazine/cc163610.aspx -->
               <netfx:NativeImage Id="ngen_LiquesceFTPSvc.exe" Platform="32bit" Priority="1" AppBaseDirectory="ServiceDIR"/>
            </File>
            <File Id="LiquesceFTPSvc.exe.config.File" Name="LiquesceFTPSvc.exe.config" Source="$(var.SvcSource)\LiquesceFTPSvc.exe.config"/>
            <ServiceControl Id='LiquesceFTPSvcControl' Name='LiquesceFTPSvc' Start='install' Stop='both' Remove='uninstall' Wait='yes' />
         </Component>
         <Component Id="LiquesceFTPFacade.dll" Directory="ServiceDIR">
            <File Source="$(var.SvcSource)\LiquesceFTPFacade.dll" KeyPath="yes" />
         </Component>
         <Component Id="NLog.dll" Directory="ServiceDIR">
            <File Source="$(var.SvcSource)\NLog.dll" KeyPath="yes" />
         </Component>
      </ComponentGroup>
      <DirectoryRef Id="ProgramMenuDir">
         <Component Id="ProgramMenuDir2" Guid="11234567-7E98-44CE-B049-C477CC0A2B01">
            <Shortcut Id="Liquesce_Shortcut" Name="Liquesce MGT" Description="Liquesce FTP Management Application" Target="[ClientDIR]LiquesceFTPMgr.exe" WorkingDirectory="ClientDIR" Icon="InstallerIcon" IconIndex="0" />
            <Shortcut Id="LiquesceTray_Shortcut" Name="Liquesce FTP Tray" Description="Liquesce FTP Tray Application" Target="[ClientDIR]LiquesceFTPTray.exe" WorkingDirectory="ClientDIR" Icon="InstallerIcon" IconIndex="0" />
            <Shortcut Id="LiquesceTray_Start" Name="Liquesce FTP Tray" Directory="StartupFolder" Description="Liquesce FTP Tray Application" Target="[ClientDIR]LiquesceFTPTray.exe" WorkingDirectory="ClientDIR" Icon="InstallerIcon" IconIndex="0" />
            <util:InternetShortcut Type="url" Id="Home" Name="Liquesce Forum" Target="[ARPHELPLINK]" />
            <util:InternetShortcut Type="link" Id="Change" Name="Change Log" Target="[ClientDIR]ChangeLog.rtf"/>
            <RemoveFolder Id="ProgramMenuDir" On="uninstall"/>
            <RegistryValue Root="HKCU" Key="Software\Microsoft\LiquesceFTP" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
         </Component>
      </DirectoryRef>

      <Feature Id="ProductFeature" Title="Liquesce_FTP_Setup" Level="1">
         <ComponentGroupRef Id="Service" />
         <ComponentRef Id="DataDir" />
         <ComponentGroupRef Id="Client" />
         <ComponentRef Id='ProgramMenuDir2'/>
      </Feature>


      <!--Write custom actions to install, uninstall, commit and rollback the changes-->
      <CustomAction Id="LiquesceFTPSvc.commit.SetProperty" Property="LiquesceFTPSvc.commit"
        Value='"[NETFRAMEWORK40FULLINSTALLROOTDIR]InstallUtil.exe" /installtype=notransaction /action=commit /LogFile="[LiquesceFTPSvc_Data]LiquesceFTPSvc.commit.log" /InstallStateDir="[CommonAppDataFolder]LiquesceFTPSvc" "[#LiquesceFTPSvc.File]"' />

      <CustomAction Id="LiquesceFTPSvc.rollback.SetProperty" Property="LiquesceFTPSvc.rollback"
        Value='"[NETFRAMEWORK40FULLINSTALLROOTDIR]InstallUtil.exe" /installtype=notransaction /action=rollback /LogFile="[LiquesceFTPSvc_Data]LiquesceFTPSvc.rollback.log" /InstallStateDir="[CommonAppDataFolder]LiquesceFTPSvc" "[#LiquesceFTPSvc.File]"' />

      <CustomAction Id="LiquesceFTPSvc.install.SetProperty" Property="LiquesceFTPSvc.install"
        Value='"[NETFRAMEWORK40FULLINSTALLROOTDIR]InstallUtil.exe" /installtype=notransaction /action=install /LogFile="[LiquesceFTPSvc_Data]LiquesceFTPSvc.install.log" /InstallStateDir="[CommonAppDataFolder]LiquesceFTPSvc" "[#LiquesceFTPSvc.File]"' />

      <CustomAction Id="LiquesceFTPSvc.uninstall.SetProperty" Property="LiquesceFTPSvc.uninstall"
        Value='"[NETFRAMEWORK40FULLINSTALLROOTDIR]InstallUtil.exe" /installtype=notransaction /action=uninstall /LogFile="[LiquesceFTPSvc_Data]LiquesceFTPSvc.uninstall.log" /InstallStateDir="[CommonAppDataFolder]LiquesceFTPSvc" "[#LiquesceFTPSvc.File]"' />

      <CustomAction Id="LiquesceFTPSvc.commit" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="commit" Impersonate="no" Return="check" />
      <CustomAction Id="LiquesceFTPSvc.rollback" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="rollback" Impersonate="no" Return="check" />
      <CustomAction Id="LiquesceFTPSvc.install" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="deferred" Impersonate="no" Return="check" />
      <CustomAction Id="LiquesceFTPSvc.uninstall" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="deferred" Impersonate="no" Return="check" />

      <!--Custom Actions to start stop Application tray-->
      <CustomAction Id="StartTrayApp" FileKey="LiquesceFTPTray.exe" ExeCommand="" Return="asyncNoWait" />
      <util:CloseApplication CloseMessage="yes" Id="CloseServerTray" Target="LiquesceFTPTray.exe" RebootPrompt="no"/>
      <CustomAction Id="MgtApp" FileKey="LiquesceFTPMgr.exe" ExeCommand="" Return="asyncNoWait" />
      <util:CloseApplication CloseMessage="yes" Id="CloseMgtAppTray" Target="LiquesceFTPMgr.exe" RebootPrompt="no"/>

      <InstallUISequence>
         <Custom Action="WixCloseApplications" Before="LaunchConditions" />
      </InstallUISequence>

      <!-- Now to sequence these Custom Actions in the execute sequence -->
      <InstallExecuteSequence>
         <Custom Action="WixCloseApplications" Before="LaunchConditions" />

         <Custom Action="LiquesceFTPSvc.commit.SetProperty" After="InstallServices"><![CDATA[ $LiquesceFTPSvc > 2 ]]></Custom>
         <Custom Action="LiquesceFTPSvc.commit" After="LiquesceFTPSvc.commit.SetProperty"><![CDATA[ $LiquesceFTPSvc > 2 ]]></Custom>

         <Custom Action="LiquesceFTPSvc.rollback.SetProperty" After="LiquesceFTPSvc.commit"><![CDATA[ $LiquesceFTPSvc > 2 ]]></Custom>
         <Custom Action="LiquesceFTPSvc.rollback" After="LiquesceFTPSvc.rollback.SetProperty"><![CDATA[ $LiquesceFTPSvc > 2 ]]></Custom>

         <Custom Action="LiquesceFTPSvc.install.SetProperty" After="LiquesceFTPSvc.rollback"><![CDATA[ $LiquesceFTPSvc > 2 ]]></Custom>
         <Custom Action="LiquesceFTPSvc.install" After="LiquesceFTPSvc.install.SetProperty"><![CDATA[ $LiquesceFTPSvc > 2 ]]></Custom>

         <Custom Action="LiquesceFTPSvc.uninstall.SetProperty" After="MsiUnpublishAssemblies"><![CDATA[ $LiquesceFTPSvc = 2 ]]></Custom>
         <Custom Action="LiquesceFTPSvc.uninstall" After="LiquesceFTPSvc.uninstall.SetProperty"><![CDATA[ $LiquesceFTPSvc = 2 ]]></Custom>
         <Custom Action="StartTrayApp" After="InstallFinalize">Not Installed</Custom>
         <Custom Action="MgtApp" After="StartTrayApp">Not Installed</Custom>
      </InstallExecuteSequence>

      <!-- Get the install to skip a few steps -->
      <UIRef Id="WixUI_Common" />
      <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" />
      <!-- This just adds 90K on top of the UI Extension.dll -->
      <UI>
         <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
         <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
         <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
         <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />

         <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />
         <Property Id="ARPNOMODIFY" Value="1" />

         <DialogRef Id="BrowseDlg" />
         <DialogRef Id="DiskCostDlg" />
         <DialogRef Id="ErrorDlg" />
         <DialogRef Id="FatalError" />
         <DialogRef Id="FilesInUse" />
         <DialogRef Id="MsiRMFilesInUse" />
         <DialogRef Id="PrepareDlg" />
         <DialogRef Id="ProgressDlg" />
         <DialogRef Id="ResumeDlg" />
         <DialogRef Id="UserExit" />

         <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999">1</Publish>
         <Publish Dialog="WelcomeEulaDlg" Control="Install" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
         <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="WelcomeEulaDlg" Order="1">NOT Installed</Publish>
         <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="2">Installed</Publish>

         <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>
         <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
         <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
         <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg">1</Publish>

      </UI>



      <UIRef Id="WixUI_ErrorProgressText" />

   </Product>
</Wix>
